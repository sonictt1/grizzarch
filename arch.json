{
	"variables": {
		"iso_url": "https://mirrors.ocf.berkeley.edu/archlinux/iso/{{ isotime \"2006.01\" }}.01/archlinux-{{ isotime \"2006.01\" }}.01-x86_64.iso",
		"iso_checksum_url": "https://mirrors.ocf.berkeley.edu/archlinux/iso/{{ isotime \"2006.01\" }}.01/sha1sums.txt",
		"iso_checksum_type": "sha1",
		"ssh_timeout": "1m",
		"ssh_port": "22",
		"country": "US",
		"region": "Central",
		"headless": "false",
		"guest_additions_path": "/tmp/",
		"arch_user": "testuser",
		"arch_pass": "testpass12",
		"encryption_pass": "testpass12",
		"arch_iso_filename": "arch_amd64_{{isotime \"2006_01\"}}_01",
		"arch_iso_path": "packer_cache",
		"output_path": "output-virtualbox-iso",
		"memory": "4096",
		"cpus": "2",
		"root_size": "8GB",
		"hostname": "grizzarch",
		"arch_vol_grp_name": "GrizzVolGrp",
		"temp_install_script_folder_name": "temp_install_scripts",
		"skip_export": "false",
		"vb_x_conf_file_name": "80-virtualbox-x11.conf",
		"vbox_graphics_controller": "vmsvga",
		"vbox_vram_mb": "16",
		"user_scripts"
	},
	"builders": [
		{
			"type": "virtualbox-iso",
			"iso_url": "{{ user `iso_url` }}",
			"iso_checksum_url": "{{ user `iso_checksum_url` }}",
			"iso_checksum_type": "{{ user `iso_checksum_type` }}",
			"guest_os_type": "ArchLinux_64",
			"guest_additions_mode": "disable",
			"http_directory": "http",
			"boot_wait": "3s",
			"iso_target_path": "{{user `arch_iso_path`}}/{{user `arch_iso_filename`}}.iso",
			"disk_size": 20480,
			"hard_drive_interface": "sata",
			"ssh_username": "{{user `arch_user`}}",
			"ssh_password": "{{user `arch_pass`}}",
			"ssh_timeout": "{{ user `ssh_timeout` }}",
			"shutdown_command": "echo '{{ user `arch_pass` }}' | sudo -S shutdown now",
			"headless": "{{ user `headless`}}",
			"cpus": "{{ user `cpus` }}",
			"memory": "{{ user `memory` }}",
			"vm_name": "grizzarch-automated-{{ isotime \"2006-01-02-030405\" }}",
			"skip_export": "{{ user `skip_export` }}",
			"boot_command": [
				"<up><up><enter><wait30>",
				"/usr/bin/curl -O http://{{ .HTTPIP }}:{{ .HTTPPort }}/user-setup.sh<enter><wait3>",
				"/usr/bin/curl -O http://{{ .HTTPIP }}:{{ .HTTPPort }}/set_up_drives_LVM_on_LUKS.sh<enter><wait3>",
				"/usr/bin/curl -O http://{{ .HTTPIP }}:{{ .HTTPPort }}/arch-install.sh<enter><wait3>",
				"/usr/bin/curl -O http://{{ .HTTPIP }}:{{ .HTTPPort }}/sfdisk_input.conf<enter><wait3>",
				"/usr/bin/curl -O http://{{ .HTTPIP }}:{{ .HTTPPort }}/mkinitcpio-custom.conf<enter><wait3>",
				"/usr/bin/curl -O http://{{ .HTTPIP }}:{{ .HTTPPort }}/configure-arch.sh<enter><wait3>",
				"/usr/bin/curl -O http://{{ .HTTPIP }}:{{ .HTTPPort }}/setup-arch-user.sh<enter><wait3>",
				"/usr/bin/curl -O http://{{ .HTTPIP }}:{{ .HTTPPort }}/swap-file-setup.sh<enter><wait3>",
				"/usr/bin/curl -O http://{{ .HTTPIP }}:{{ .HTTPPort }}/move_files_to_new_install.sh<enter><wait3>",
				"chown root ./*.sh<enter><wait2>",
				"chmod 744 ./*.sh<enter><wait2>",
				"/usr/bin/bash ./set_up_drives_LVM_on_LUKS.sh -p ./sfdisk_input.conf -g GrizzVolGrp -d \"/dev/sda\" -r \"{{user `root_size`}}\" -P {{user `encryption_pass`}}<enter><wait15>",
				"/usr/bin/bash ./arch-install.sh -f \"mkinitcpio-custom.conf\" -p \".\"<wait1><enter><wait145>",
				"/usr/bin/bash ./move_files_to_new_install.sh -n {{ user `temp_install_script_folder_name` }}<enter><wait3>",
				"arch-chroot /mnt<enter><wait3>",
				"./{{ user `temp_install_script_folder_name` }}/configure-arch.sh -c '{{ user `country` }}' -r '{{ user `region` }}' -h {{ user `hostname` }} -g {{ user `arch_vol_grp_name` }}<enter><wait30>",
				"./{{ user `temp_install_script_folder_name` }}/swap-file-setup.sh<enter><wait3>",
				"./{{ user `temp_install_script_folder_name` }}/setup-arch-user.sh -s {{ user `ssh_port` }} -u {{ user `arch_user` }} -p {{ user `arch_pass` }}<enter><wait10>",
				"rm -r {{ user `temp_install_script_folder_name` }}<enter><wait1>",
				"pacman -Sy --noconfirm virtualbox-guest-utils<enter><wait5>",
				"exit<enter><wait2>",
				"efibootmgr --bootnum 0001 --inactive<enter><wait1>",
				"reboot now<enter><wait100s>"
			],
			"vboxmanage": [
				[
					"modifyvm",
					"{{.Name}}",
					"--firmware",
					"efi64"
				]
			],
			"vboxmanage_post": [
				[
					"modifyvm",
					"{{.Name}}",
					"--graphicscontroller",
					"{{ user `vbox_graphics_controller` }}",
					"--vram",
					"{{ user `vbox_vram_mb` }}"
				]
			]
		}
	],
	"provisioners": [
		{
			"type": "file",
			"source": "ssh/10-virtualbox-x11.conf",
			"destination": "/home/{{ user `arch_user` }}/{{ user `vb_x_conf_file_name` }}"
		},
		{
			"type": "shell",
			"script": "ssh/create-directories.sh",
			"execute_command": "chmod +x {{ .Path }}; {{ .Vars }} {{ .Path }} -u {{ user `arch_user` }}"
		},
		{
			"type": "shell",
			"scripts": [
				"ssh/other-packages.sh"
			],
			"execute_command": "chmod +x {{ .Path }}; echo '{{ user `arch_pass` }}' | sudo -S {{ .Vars }} {{ .Path }}"
		},
		{
			"type": "file",
			"source": "ssh/i3_conf",
			"destination": "/home/{{ user `arch_user` }}/.config/i3/config"
		},
		{
			"type": "file",
			"source": "ssh/term_conf",
			"destination": "/home/{{ user `arch_user` }}/.config/termite/config"
		},
		{
			"type": "file",
			"source": "ssh/.xinitrc",
			"destination": "/home/{{ user `arch_user` }}/.xinitrc"
		},
		{
			"type": "file",
			"source": "ssh/.bash_profile",
			"destination": "/home/{{ user `arch_user` }}/.bash_profile"
		},
		{
			"type": "shell",
			"inline": [
				"mkdir -p /usr/X11/xorg.conf.d/",
				"mv /home/{{ user `arch_user` }}/{{ user `vb_x_conf_file_name` }} /usr/X11/xorg.conf.d/{{ user `vb_x_conf_file_name` }}"
			],
			"execute_command": "chmod +x {{ .Path }}; echo '{{ user `arch_pass` }}' | sudo -S {{ .Vars }} {{ .Path }}"
		},
		{
			"type": "shell",
			"inline": [
				"systemctl enable vboxservice"
			],
			"only": [
				"virtualbox-iso"
			]
		}
	]
}